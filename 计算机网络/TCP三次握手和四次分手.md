### **1. 为什么需要三次握手？**

**目的**：同步初始序列号（ISN），验证双方发送和接收能力，防止历史连接干扰。



- **第一次握手（客户端→服务器）**：客户端发送 SYN 包，携带初始序列号 x，证明客户端的发送能力正常。
- **第二次握手（服务器→客户端）**：服务器返回 SYN+ACK 包，确认号为 x+1（确认客户端的 SYN），同时发送自己的初始序列号 y，证明服务器的接收和发送能力正常。
- **第三次握手（客户端→服务器）**：客户端发送 ACK 包，确认号为 y+1（确认服务器的 SYN），证明客户端的接收能力正常。
  **关键点**：三次握手是验证双方收发能力的最小次数。若采用两次握手，服务器无法确认客户端是否能收到自己的 SYN 包，可能导致 “半连接” 状态。

### **2. 第 2 次握手传回了 ACK，为什么还要传回 SYN？**

- **ACK**：确认客户端的 SYN 包，确保客户端知道服务器已收到请求。
- **SYN**：服务器主动发起连接请求，同步自己的初始序列号 y。TCP 是全双工协议，双方都需作为发送方和接收方，因此服务器也需要客户端确认自己的 SYN 包。
  **一句话总结**：ACK 是回应，SYN 是请求，两者缺一不可。

### **3. 为什么需要四次挥手？**

**目的**：确保双方都能优雅地关闭连接，释放资源。



- **第一次挥手（客户端→服务器）**：客户端发送 FIN 包，表示 “我已没有数据要发送，但仍可接收”。
- **第二次挥手（服务器→客户端）**：服务器返回 ACK 包，表示 “我已收到你的关闭请求，同意关闭”。此时客户端到服务器的连接关闭（半关闭）。
- **第三次挥手（服务器→客户端）**：服务器发送 FIN 包，表示 “我也没有数据要发送了，准备关闭”。
- **第四次挥手（客户端→服务器）**：客户端返回 ACK 包，表示 “同意关闭，确认你的 FIN”。此时服务器到客户端的连接关闭。
  **关键点**：TCP 是全双工的，每个方向的关闭都需要独立的 FIN 和 ACK。

### **4. 为什么不能把服务器的 ACK 和 FIN 合并为三次挥手？**

理论上，如果服务器在收到客户端的 FIN 后立即无数据可发送，确实可以合并 ACK 和 FIN。但 TCP 协议设计时认为这两个动作是独立的：



- **ACK**：是对客户端 FIN 的立即响应，确保客户端知道 “我的请求已被接收”。
- **FIN**：取决于服务器自身是否还有数据要发送，可能需要等待应用层处理完剩余数据后再发送。
  **实际场景**：服务器可能需要等待数据库查询结果、缓存刷新等操作完成后才发送 FIN，因此通常分两次发送。

### **5. 如果第二次挥手的 ACK 未送达客户端，会发生什么？**

- 客户端未收到 ACK，会超时重传 FIN 包（默认重传 5 次，间隔指数递增：1s, 2s, 4s, 8s, 16s）。
- 服务器会重复收到 FIN 包，每次都回复 ACK（但不会重复发送 FIN，因为 FIN 的发送由应用层控制）。
- 如果一直收不到 ACK，客户端最终会放弃并关闭连接，而服务器可能仍认为连接处于半关闭状态，直到超时（通常 2 小时）。
  **风险**：服务器可能长时间保持无效连接，消耗资源。

### **6. 为什么第四次挥手后客户端需要等待 2\*MSL（报文段最长寿命）？**

**目的**：确保最后一个 ACK 能到达服务器，同时防止 “过期数据包” 干扰后续连接。



- **防止 ACK 丢失**：若 ACK 丢失，服务器会重传 FIN，客户端在 2*MSL 内可收到并重发 ACK，避免服务器因收不到 ACK 而无法关闭。
- **清理网络中残留的数据包**：2*MSL 是 “最长报文段寿命” 的两倍，足够让本次连接的所有数据包在网络中自然消亡，防止新连接收到旧连接的数据包。
  **MSL**：通常为 2 分钟（RFC 793 建议值），但实际实现中常缩短为 30 秒或更短。

### **总结表格**

| 问题                    | 核心原因                                                     |
| ----------------------- | ------------------------------------------------------------ |
| 三次握手的必要性        | 验证双方收发能力，同步初始序列号，防止历史连接干扰。         |
| SYN 和 ACK 必须同时回传 | TCP 是全双工协议，服务器需作为发送方同步自己的初始序列号。   |
| 四次挥手的必要性        | 全双工连接的每个方向需独立关闭，FIN 和 ACK 是不同操作。      |
| ACK 和 FIN 不能合并     | 服务器可能需要等待应用层处理完数据后再发送 FIN，与 ACK 响应时机无关。 |
| 等待 2*MSL 时间         | 确保 ACK 送达服务器，避免残留数据包干扰新连接。              |