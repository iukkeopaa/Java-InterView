## 

在自己的项目中我设计了用户表和用户手机号，用户邮箱表，现在你可能可能会问为什么要单独设计这两个手机和邮箱表，其实在用户登录时，是可以用手机号和邮箱登录的，也就是需要用手机号和邮箱来查询用户信息，而在订单业务中也需要查询用户信息，使用的是用户id来查询。而我们是使用的用户id作为分片键，使用手机号 和 邮箱 就会造成 全路由 的问题】】



## 全路由问题

所谓的全路由，就是查询或者操作数据时，没有分片键的条件，ShardingSphere  无法定位数据具体到在哪个库，哪个表。就只能去所有的分片库，分片表上查询，这种情况的执行效率是非常慢的，会有数据库连接超时、接口超时 各种的问题。


## 解决方法


为了解决 手机号和邮箱登录 而且不造成 全路由 的问题。采取附属表的方案，设置了 用户手机表 和 用户邮箱表 ，通过手机号 和 邮箱 查询到 用户id，然后使用用户id查询用户表，这样就解决了问题。


## 设计详情

### 用户表

```mysql
CREATE TABLE `d_user` (
  `id` bigint(20) NOT NULL COMMENT '主键id',
  `name` varchar(256) DEFAULT NULL COMMENT '用户名字',
  `rel_name` varchar(256) DEFAULT NULL COMMENT '用户真实名字',
  `mobile` varchar(512) NOT NULL COMMENT '手机号',
  `gender` int(11) NOT NULL DEFAULT '1' COMMENT '1:男 2:女',
  `password` varchar(512) DEFAULT NULL COMMENT '密码',
  `email_status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否邮箱认证 1:已验证 0:未验证',
  `email` varchar(256) DEFAULT NULL COMMENT '邮箱地址',
  `rel_authentication_status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否实名认证 1:已验证 0:未验证',
  `id_number` varchar(512) DEFAULT NULL COMMENT '身份证号码',
  `address` varchar(256) DEFAULT NULL COMMENT '收货地址',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `edit_time` datetime DEFAULT NULL COMMENT '编辑时间',
  `status` tinyint(1) NOT NULL DEFAULT '1' COMMENT '1:正常 0:删除',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

## 用户手机表

```mysql

CREATE TABLE `d_user_mobile` (
  `id` bigint(20) NOT NULL COMMENT '主键id',
  `user_id` bigint(20) NOT NULL COMMENT '用户id',
  `mobile` varchar(512) NOT NULL COMMENT '手机号',
  `create_time` datetime NOT NULL COMMENT '创建时间',
  `edit_time` datetime NOT NULL COMMENT '编辑时间',
  `status` tinyint(1) NOT NULL DEFAULT '1' COMMENT '1:正常 0:删除',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户手机表';```

```

## 用户邮箱表

```mysql
CREATE TABLE `d_user_email` (
  `id` bigint(20) NOT NULL COMMENT '主键id',
  `user_id` bigint(20) NOT NULL COMMENT '用户id',
  `email` varchar(512) NOT NULL COMMENT '邮箱',
  `create_time` datetime NOT NULL COMMENT '创建时间',
  `edit_time` datetime NOT NULL COMMENT '编辑时间',
  `status` tinyint(1) NOT NULL DEFAULT '1' COMMENT '1:正常 0:删除',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户邮箱表';
```

## 购票人表

```mysql
CREATE TABLE `d_ticket_user` (
                                 `id` bigint(20) NOT NULL COMMENT '主键id',
                                 `user_id` bigint(20) NOT NULL COMMENT '用户id',
                                 `rel_name` varchar(256) NOT NULL COMMENT '用户真实名字',
                                 `id_type` int(11) NOT NULL DEFAULT '1' COMMENT '证件类型 1:身份证 2:港澳台居民居住证 3:港澳居民来往内地通行证 4:台湾居民来往内地通行证 5:护照 6:外国人永久居住证',
                                 `id_number` varchar(512) NOT NULL COMMENT '证件号码',
                                 `create_time` datetime NOT NULL COMMENT '创建时间',
                                 `edit_time` datetime NOT NULL COMMENT '编辑时间',
                                 `status` tinyint(1) NOT NULL DEFAULT '1' COMMENT '1:正常 0:删除',
                                 PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='购票人表';
```


## 优缺点


**优点**
1. 以后如果需要其他方式的登录方式，比如说用户名，微信，支付宝登录等，只需要新建相关的表即可


**缺点**
1. 增加了数据库的查询次数，增加了数据库的压力
2. 增加了数据库的表数量，额外多了用户手机表和用户邮箱表，随着数据量的越来越大，表容量的占用也越来越大，需要额外的维护


## 延申

在订单的业务中，除了使用订单号来查询还可以使用买家或者说是用户id来进行查询，其中利用到了基因法的方法，其实也很简单就是进行数据的的冗余在查询字段上


## 