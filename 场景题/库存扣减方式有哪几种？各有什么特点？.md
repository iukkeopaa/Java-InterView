### **一、按扣减时机划分**

#### 1. 下单时扣减（预扣减）

- **定义**：用户提交订单时（未支付）立即扣减库存，锁定库存数量。

- 特点

  ：

    - 优点：能**有效防止超卖**（库存一旦被下单锁定，其他订单无法占用），适合高并发场景（如秒杀、促销）；
    - 缺点：库存可能被 “无效占用”（如用户下单后放弃支付），导致库存利用率低；需配合 “超时释放” 机制（如 15 分钟未支付自动取消订单并释放库存）。

- **适用场景**：秒杀、限时抢购、高优先级订单（需优先锁定库存）。

#### 2. 支付后扣减

- **定义**：用户下单时仅记录订单信息，不扣减库存；待用户完成支付后，再扣减库存。

- 特点

  ：

    - 优点：库存不会被无效占用（仅支付成功的订单才扣减），库存利用率高；
    - 缺点：存在**超卖风险**（支付过程中，库存可能被其他订单抢走）；需在支付时再次校验库存，若库存不足需处理 “支付成功但库存不足” 的异常（如退款 + 致歉）。

- **适用场景**：低并发场景（如普通商品日常销售）、库存周转率低的商品（避免无效锁定）。

#### 3. 确认履约时扣减（如发货 / 出库时）

- **定义**：下单、支付时均不扣减库存，仅在确认发货（或出库）时扣减。

- 特点

  ：

    - 优点：库存灵活性最高（可在发货前根据实际库存调整，减少超卖）；适合 “预售”“按需采购” 等业务（如先接单，再备货）；
    - 缺点：对前端展示库存的准确性要求高（需实时同步可售库存）；若备货延迟，可能导致订单取消，影响用户体验。

- **适用场景**：预售商品、定制化商品、依赖供应链备货的业务。

### **二、按技术实现方式划分**

#### 1. 同步扣减（实时扣减）

- **定义**：订单流程与库存扣减同步执行（如下单接口直接调用库存扣减接口，扣减成功才返回订单创建成功）。

- 特点

  ：

    - 优点：实时性强，库存状态即时更新，一致性高；
    - 缺点：若库存服务响应慢，会阻塞订单流程，降低系统吞吐量；需处理扣减失败的回滚（如订单创建失败需释放库存）。

- **适用场景**：对一致性要求高的场景（如秒杀、高频交易）。

#### 2. 异步扣减（消息驱动）

- **定义**：订单创建后，通过消息队列（如 RabbitMQ、Kafka）发送扣减指令，库存服务异步消费消息并执行扣减，最终通过回调确认结果。

- 特点

  ：

    - 优点：解耦订单与库存服务，提升系统吞吐量；避免订单流程被库存服务阻塞；
    - 缺点：存在短暂的库存不一致（消息未消费前，库存未扣减）；需处理消息重复（幂等性设计）、消息丢失（持久化）、顺序性（避免重复扣减或漏扣）等问题，保证最终一致性。

- **适用场景**：高并发、非实时强一致的场景（如普通电商订单）。

#### 3. 基于锁机制的扣减

通过数据库锁或分布式锁保证扣减的原子性，避免并发冲突。

- **悲观锁扣减**：
    - 实现：扣减时通过`select ... for update`锁定库存记录，确保同一时间只有一个线程操作。
    - 特点：安全性高，适合并发低的场景；但锁竞争激烈时会导致性能下降（线程阻塞）。
- **乐观锁扣减**：
    - 实现：基于版本号（如`version`字段）或库存值校验（`where stock >= num`），扣减时通过条件判断（如`update stock set count = count - num where id = ? and count >= num`），失败则重试。
    - 特点：无锁竞争，性能高，适合高并发场景；但需处理重试逻辑（避免无限重试），且在极端并发下可能出现 “库存为负”（需额外校验）。

#### 4. 预占 + 释放机制（冻结 - 扣减模式）

- **定义**：分两步：① 下单时 “预占库存”（冻结库存，标记为 “待扣减”）；② 支付 / 发货时 “确认扣减”（将冻结库存转为实际扣减）；若订单取消，则 “释放冻结库存”。

- 特点

  ：

    - 优点：库存状态更清晰（可售库存 = 总库存 - 冻结库存）；便于监控无效占用（如冻结超时未扣减的库存）；
    - 缺点：实现复杂（需维护冻结库存、可售库存两个字段）；需处理冻结与扣减的一致性（如冻结成功但扣减失败的回滚）。

- **适用场景**：支持 “超时未支付取消”“订单修改” 等业务的系统（如电商平台）。

### **三、按业务场景特殊需求划分**

#### 1. 分渠道扣减（预留库存）

- **定义**：将总库存按渠道（如普通渠道、秒杀渠道、会员渠道）拆分，扣减时仅从对应渠道的预留库存中扣减。

- 特点

  ：

    - 优点：避免不同渠道争抢库存（如秒杀不占用普通用户的库存）；便于精细化运营（控制各渠道库存占比）；
    - 缺点：需提前规划各渠道库存分配，灵活性低（若某渠道库存不足，无法动态调配）。

- **适用场景**：多渠道销售（如电商平台的普通商品、秒杀商品、直播间专属库存）。

#### 2. 批量扣减

- **定义**：对多个订单或商品批量执行库存扣减（如定时任务批量处理待扣减的库存）。

- 特点

  ：

    - 优点：减少高频次单条扣减的性能损耗，适合低优先级、非实时的业务；
    - 缺点：实时性差，可能导致短时间内库存展示不准确。

- **适用场景**：夜间批量处理、低频次订单的业务（如企业采购订单）。

### **总结**

库存扣减方式的选择需结合**业务流程（下单 - 支付 - 发货）**、**并发量**、**一致性要求**和**系统性能目标**：

- 高并发 + 防超卖：优先 “下单预扣 + 乐观锁 + 同步扣减”；
- 高吞吐 + 低一致性：可选 “异步扣减 + 消息队列”；
- 多渠道 / 精细化运营：采用 “分渠道预留库存”；
- 预售 / 备货业务：适合 “确认发货时扣减”。

核心是在 “防超卖”“库存利用率”“系统性能” 之间找到平衡，同时通过超时释放、幂等设计、补偿机制等保证最终一致性。